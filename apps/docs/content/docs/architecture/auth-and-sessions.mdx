---
title: Auth and Sessions
description: Email/password + passkey authentication with MFA and server-side sessions.
---

## Model

The API uses a backend-for-frontend (BFF) pattern:

1. The browser calls API auth routes for login, MFA, password reset, and passkey ceremonies.
2. Axum verifies credentials server-side (Argon2id password hashes + WebAuthn assertions).
3. Session state is persisted in PostgreSQL via `tower-sessions-sqlx-store`.
4. The frontend never stores bearer tokens directly.

## Session Behavior

- Cookie flags: `HttpOnly=true`, `SameSite=Lax`
- `Secure=false` in local development (`SESSION_COOKIE_SECURE=true` in production)
- Session table: `tower_sessions`
- Inactivity timeout: 30 minutes
- Absolute timeout: 8 hours (`require_auth` enforces `session_created_at`)
- Session id is rotated on authentication (`session.cycle_id()`)

`require_auth` middleware reads `UserIdentity` from session and injects it into request extensions for protected routes.

## Password and MFA Flows

- `POST /auth/register` creates email/password users and sends verification mail when tenant registration mode allows open signup.
- `POST /auth/login` authenticates passwords and returns `mfa_required` when TOTP is enabled.
- `POST /auth/login/mfa` verifies TOTP or single-use recovery codes.
- `POST /auth/forgot-password` and `POST /auth/reset-password` implement token-based recovery.
- `PUT /api/profile/password` rotates passwords for authenticated users.
- `POST /auth/mfa/totp/*` and `/auth/mfa/recovery-codes/regenerate` manage MFA enrollment and recovery.
- Successful registration/login/bootstrap/invite/passkey flows ensure the subject is represented by a runtime `contact` record in tenant scope.

Registration mode behavior:

- If `DEV_DEFAULT_TENANT_ID` is configured, `/auth/register` uses that tenant's `registration_mode` (`invite_only` by default in schema).
- If no default tenant is configured, `/auth/register` remains open and creates tenant membership for the new user.
- Invite acceptance (`/auth/invite/accept`) is allowed regardless of registration mode.
- Tenant admins can read/update registration mode through `/api/security/registration-mode`.

Password hashing uses Argon2id (`m=19456, t=2, p=1`) per OWASP Password Storage guidance.

## Invite Flows

- `POST /auth/invite` issues signed invite links for tenant onboarding.
- `POST /auth/invite/accept` accepts invite tokens, creates memberships, and starts a session.
- Invite issuance requires authenticated permission checks and route-specific abuse throttling.

## Auth Token Guarantees

- Verification, reset, and invite tokens are random and stored as SHA-256 hashes.
- Token validation and consumption are atomic at persistence time to reduce replay races.
- All token errors return the same unauthorized response (`invalid or expired token`).

## WebAuthn Responsibilities

`/auth/webauthn/*` performs:

1. Challenge generation and server-side state persistence
2. Passkey attestation/assertion verification
3. Credential counter update and replay resistance
4. Subject-to-tenant lookup through `TenantRepository`
5. Session write of `UserIdentity`

Passkeys remain available as an optional login and account-hardening path.

## Bootstrap Session Flow

`/auth/bootstrap` validates the bootstrap token and ensures the subject can resolve to a tenant membership.

- If a membership already exists, that tenant is used.
- If no membership exists, the API creates one during bootstrap.
- Bootstrap and other successful auth flows also ensure default `contact` metadata is published for the tenant.
- `DEV_DEFAULT_TENANT_ID` can pin local bootstrap to a known tenant UUID; if unset, a tenant is created for first-time bootstrap subjects.
- Bootstrap rotates the session id and records absolute session creation time like other successful auth flows.

## CSRF and Origin Defense

State-changing requests enforce same-origin headers and reject `Sec-Fetch-Site: cross-site` traffic.

## Rate Limiting

Auth endpoints use database-backed sliding-window limits (`auth_rate_limits`) keyed by route category + client IP.

- Login: 10 attempts per 15 minutes
- Registration: 5 attempts per hour
- Forgot password: 5 attempts per hour
- Invite acceptance: 10 attempts per hour
- Resend verification: 5 attempts per hour per authenticated subject
- Invite send: 20 attempts per hour per authenticated subject
- Invite recipient: 3 attempts per hour per tenant+recipient
- Verify email token: 30 attempts per hour per source IP

HTTP `429` responses include a `Retry-After` header.
