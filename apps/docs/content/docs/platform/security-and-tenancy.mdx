---
title: Security and Tenancy
description: Authentication, authorization, and strict tenant boundary model.
---

Phase status: implemented baseline with ongoing hardening.

## Security Baseline

- Email + password login (`/auth/login`) with Argon2id password hashing
- TOTP MFA and recovery codes (`/auth/login/mfa`, `/auth/mfa/totp/*`)
- Forgot password and email verification token flows
- Invite-based onboarding (`/auth/invite`, `/auth/invite/accept`)
- WebAuthn passkey login (`/auth/webauthn/login/start` + `/auth/webauthn/login/finish`)
- Server-side session cookie (`tower-sessions`)
- Route protection via `require_auth` middleware
- Invite issuance requires explicit permission checks (`security.invite.send`)
- Tenant lookup from `tenant_memberships` on successful authentication
- Absolute session timeout (8h), inactivity timeout (30m), and session id rotation on login
- Database-backed auth rate limiting (`auth_rate_limits`) on public auth endpoints

## Tenancy Model

Every persisted record includes tenant ownership context.
Repository methods require tenant scope in query paths to prevent leakage.

Phase 1 metadata operations require `TenantId` and query with `WHERE tenant_id = $1`.

Tenant-boundary regression guardrails:

- Integration coverage runs across in-memory and Postgres metadata repositories.
- Critical runtime paths (list/query/find/delete/relation reference checks) validate tenant scoping.
- Cross-tenant leakage scenarios are CI-gated so regressions fail deterministically.

## Authorization Pipeline

1. Route-level authentication
2. Application-level policy checks
3. Repository-level tenant scoping enforcement

## RBAC Baseline

- Permissions are evaluated in `MetadataService` via `AuthorizationService`.
- Effective grants are resolved from `rbac_subject_roles` + `rbac_role_grants`.
- Tenant bootstrap assigns a `tenant_owner` system role with metadata read/create grants.
- Role administration endpoints allow custom role creation and subject assignment.
- Security administration endpoints expose tenant registration mode read/update controls.
- Baseline permissions now include metadata field and runtime record scopes.
- Runtime permissions now include own-scope grants (`runtime.record.read.own`, `runtime.record.write.own`) for owner-constrained access.
- Metadata writes now require both entity and field-write scopes.
- Authenticated subjects are mapped to tenant-scoped runtime `contact` records during bootstrap/login flows without granting control-plane RBAC permissions.
- Security administration now supports runtime field-level read/write grants per subject and entity.
- Temporary privileged access grants can be created/revoked with explicit reason and expiration windows.

## Audit Contract

Track:

- Actor identity
- Tenant id
- Action type
- Resource id
- Timestamp
- Before/after snapshots (where applicable)

Current baseline:

- Metadata entity creation emits an append-only event in `audit_log_entries`.
- Event fields include tenant, subject, action, resource type/id, and detail.
- Role creation and assignment emit security audit events.
- Tenant registration mode updates emit `security.tenant.registration_mode.updated` audit events.
- Temporary privileged access grant create/revoke/use paths emit security audit events.
- Audit retention policy is tenant-configurable and enforced via explicit purge workflow.
- Authentication lifecycle events (bootstrap, login, MFA, passkey registration/login, logout, registration) are appended to `auth_events`.
- Audit log reads and exports support action/subject filters with offset pagination for admin review workflows.

## Security Administration APIs

Canonical route list is maintained in `API Conventions`. Current security routes:

- Role and assignment administration:
  - `GET|POST /api/security/roles`
  - `GET|POST /api/security/role-assignments`
  - `POST /api/security/role-unassignments`
- Runtime field-level permissions:
  - `GET|PUT /api/security/runtime-field-permissions`
- Temporary privileged access grants:
  - `GET|POST /api/security/temporary-access-grants`
  - `POST /api/security/temporary-access-grants/:grant_id/revoke`
- Audit operations:
  - `GET /api/security/audit-log`
  - `GET /api/security/audit-log/export`
  - `POST /api/security/audit-log/purge`
  - `GET|PUT /api/security/audit-retention-policy`
