---
title: Security and Tenancy
description: Authentication, authorization, and strict tenant boundary model.
---

## Security Baseline

- Email + password login (`/auth/login`) with Argon2id password hashing
- TOTP MFA and recovery codes (`/auth/login/mfa`, `/auth/mfa/totp/*`)
- Forgot password and email verification token flows
- Invite-based onboarding (`/auth/invite`, `/auth/invite/accept`)
- WebAuthn passkey login (`/auth/webauthn/login/start` + `/auth/webauthn/login/finish`)
- Server-side session cookie (`tower-sessions`)
- Route protection via `require_auth` middleware
- Invite issuance requires explicit permission checks (`security.invite.send`)
- Tenant lookup from `tenant_memberships` on successful authentication
- Absolute session timeout (8h), inactivity timeout (30m), and session id rotation on login
- Database-backed auth rate limiting (`auth_rate_limits`) on public auth endpoints

## Tenancy Model

Every persisted record must include tenant ownership context.
Repository methods should require tenant scope in query paths to prevent leakage.

Phase 1 metadata operations require `TenantId` and query with `WHERE tenant_id = $1`.

Tenant-boundary regression guardrails:

- Integration coverage runs across in-memory and Postgres metadata repositories.
- Critical runtime paths (list/query/find/delete/relation reference checks) validate tenant scoping.
- Cross-tenant leakage scenarios are CI-gated so regressions fail deterministically.

## Authorization Layers

1. Route-level authentication
2. Application-level policy checks
3. Repository-level tenant scoping enforcement

Current RBAC baseline:

- Permissions are evaluated in `MetadataService` via `AuthorizationService`.
- Effective grants are resolved from `rbac_subject_roles` + `rbac_role_grants`.
- Tenant bootstrap assigns a `tenant_owner` system role with metadata read/create grants.
- Role administration endpoints allow custom role creation and subject assignment.
- Security administration endpoints expose tenant registration mode read/update controls.
- Baseline permissions now include metadata field and runtime record scopes.
- Metadata writes now require both entity and field-write scopes.

## Audit Requirements

Track:

- Actor identity
- Tenant id
- Action type
- Resource id
- Timestamp
- Before/after snapshots (where applicable)

Current audit baseline:

- Metadata entity creation emits an append-only event in `audit_log_entries`.
- Event fields include tenant, subject, action, resource type/id, and detail.
- Role creation and assignment emit security audit events.
- Tenant registration mode updates emit `security.tenant.registration_mode.updated` audit events.
- Authentication lifecycle events (bootstrap, login, MFA, passkey registration/login, logout, registration) are appended to `auth_events`.
- Audit log reads support action/subject filters with offset pagination for admin review workflows.
